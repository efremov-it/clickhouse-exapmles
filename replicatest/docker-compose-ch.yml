x-shared: &image
  image: bitnami/clickhouse:24.9.1-debian-12-r2 #bitnami/clickhouse:23.1.3-debian-11-r5
  volumes:
    - ./config/clickhouse/config.d/:/bitnami/clickhouse/etc/conf.d/
    - ./config/clickhouse/users.d/:/bitnami/clickhouse/etc/users.d/

services:
  clickhouse01:
    <<: [*image]
    container_name: clickhouse01
    hostname: clickhouse01
    environment:
      CH_SHARD: 01
      ALLOW_EMPTY_PASSWORD: yes
      CLICKHOUSE_MOUNTED_DIR: /bitnami/clickhouse
    networks:
      clickhouse-network:
        ipv4_address: 172.23.0.110
  clickhouse02:
    <<: [*image]
    container_name: clickhouse02
    hostname: clickhouse02
    environment:
      CH_SHARD: 02
      ALLOW_EMPTY_PASSWORD: yes
      CLICKHOUSE_MOUNTED_DIR: /bitnami/clickhouse
    networks:
      clickhouse-network:
        ipv4_address: 172.23.0.120
  clickhouse03:
    <<: [*image]
    container_name: clickhouse03
    hostname: clickhouse03
    extra_hosts:
      - "clickhouse03:172.23.0.130"
    environment:
      CH_SHARD: 03
      ALLOW_EMPTY_PASSWORD: yes
      CLICKHOUSE_MOUNTED_DIR: /bitnami/clickhouse
    networks:
      clickhouse-network:
        ipv4_address: 172.23.0.130
  clickhouse04:
    <<: [*image]
    container_name: clickhouse04
    hostname: clickhouse04
    working_dir: /tmp
    environment:
      CH_SHARD: 04
      ALLOW_EMPTY_PASSWORD: yes
      CLICKHOUSE_MOUNTED_DIR: /bitnami/clickhouse
      KEEPER_SERVER_ID: 04
    networks:
      clickhouse-network:
        ipv4_address: 172.23.0.140

  clickhouse-01-01: &clickhouse-base
    image: "clickhouse/clickhouse-server:${CHVER:-latest}"
      # user: "101:101"
    container_name: clickhouse-01-01
    hostname: clickhouse-01-01
    environment:
      CH_SHARD: 01
    volumes:
      - type: bind
        source: ./config/clickhouse/config.d.test/
        target: /etc/clickhouse-server/config.d/
      - type: bind
        source: ./config/clickhouse/config.d/
        target: /etc/clickhouse-server/users.d/
    networks:
      - clickhouse-network
    ports:
      - "127.0.0.1:8123:8123"
      - "127.0.0.1:9000:9000"
    healthcheck:
      test: wget \
          --no-verbose \
          --tries=1 \
          --spider \
          localhost:8123/replicas_status || exit 1
      interval: 40s
      timeout: 30s
      retries: 3
      start_period: 3s
  clickhouse-01-02:
    <<: *clickhouse-base
    container_name: clickhouse-01-02
    hostname: clickhouse-01-02
    ports:
      - "127.0.0.1:8124:8124"
      - "127.0.0.1:9001:9001"
    environment:
      CH_SHARD: 01
  clickhouse-02-01:
    <<: *clickhouse-base
    container_name: clickhouse-02-01
    hostname: clickhouse-02-01
    ports:
      - "127.0.0.1:8133:8125"
      - "127.0.0.1:9011:9002"
    environment:
      CH_SHARD: 02
  clickhouse-02-02:
    <<: *clickhouse-base
    container_name: clickhouse-02-02
    hostname: clickhouse-02-02
    ports:
      - "127.0.0.1:8134:8125"
      - "127.0.0.1:9012:9000"
    environment:
      CH_SHARD: 02


networks:
  clickhouse-network:
    name: ch-network
    ipam:
      config:
        - subnet: 172.23.0.0/24
